name: Release build from tag

on:
  create:
    tags: 'v*'
  push:
    branches: [  feature/run_action_on_tag ]

jobs:
  semanticbuild:
     runs-on: ubuntu-latest
     steps:
     - name: Checkout
       uses: actions/checkout@v1
     - name: Branch name
       id: branch_name
       run: |
         echo ::set-output name=SOURCE_NAME::${GITHUB_REF#refs/*/}
         echo ::set-output name=SOURCE_BRANCH::${GITHUB_REF#refs/heads/}
         echo ::set-output name=SOURCE_TAG::${GITHUB_REF#refs/tags/}
     - name: Build base image
       run: |
         echo $SOURCE_NAME
         echo $SOURCE_BRANCH
         echo $SOURCE_TAG
       env:
         SOURCE_NAME: ${{ steps.branch_name.outputs.SOURCE_NAME }}
         SOURCE_BRANCH: ${{ steps.branch_name.outputs.SOURCE_BRANCH }}
         SOURCE_TAG: ${{ steps.branch_name.outputs.SOURCE_TAG }}

#     - id: get_version
#       uses: battila7/get-version-action@v2
#     - name: Version Reader
#       run: echo ${{ steps.get_version.outputs.version }} - ${{ steps.get_version.outputs.version-without-v }}
#     - name: Dockerhub login
#       env:
#         DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
#         DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
#       run: echo "${DOCKER_PASSWORD}" | docker login --username ${DOCKER_USERNAME} --password-stdin
#     - name: Set up Docker Buildx
#       id: buildx
#       uses: crazy-max/ghaction-docker-buildx@v1
#       with:
#         version: latest
#     - name: Build image with all platforms (with push)
#       run: docker buildx build --platform=linux/amd64 -t fabiolune/nginx-custom-backend:build -f Dockerfile --push .
#     - name: Build dockerfile (with push)
#       run: docker buildx build --platform=linux/arm/v7,linux/arm64/v8,linux/amd64 -t fabiolune/nginx-custom-backend:latest -f publish.Dockerfile --push .
#     - name: delete build base image from docker hub
#       run: |
#          HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "'${DOCKER_USERNAME}'", "password": "'${DOCKER_PASSWORD}'"}' https://hub.docker.com/v2/users/login/ | grep -o '"token":[^"]*"[^"]*"' | sed -E 's/".*".*"(.*)"/\1/') && \
#          curl -i -X DELETE -H "Accept: application/json" -H "Authorization: JWT $HUB_TOKEN" https://hub.docker.com/v2/repositories/fabiolune/nginx-custom-backend/tags/build/
